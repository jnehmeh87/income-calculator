<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freelance Rate & Income Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Nordic Calm -->
    <!-- Application Structure Plan: Dashboard. Module 1: Rate definition. Module 2: Income projection with multi-currency support, including manual tax rate for US. OB rates scale. All inputs saved. Module 3: Considerations. -->
    <!-- Visualization & Content Choices: Rate Breakdown -> Donut Chart + Input. Income Projections -> Sliders/Inputs + Dynamic Text + Stacked Bar Chart. OB/Transportation/Tax sections. All dynamically update based on selected country config. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px; 
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        .comparison-chart-container { 
            position: relative;
            width: 100%;
            max-width: 600px; 
            margin-left: auto;
            margin-right: auto;
            height: 300px; 
            max-height: 350px;
        }
        @media (max-width: 640px) {
            .chart-container {
                height: 300px;
            }
            .comparison-chart-container {
                height: 250px;
            }
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #1e40af; 
            cursor: pointer;
            border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #1e40af; 
            cursor: pointer;
            border-radius: 50%;
        }
        .input-number-custom {
            -moz-appearance: textfield;
        }
        .input-number-custom::-webkit-outer-spin-button,
        .input-number-custom::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Freelance Rate & Income Calculator</h1>
            <p class="mt-2 text-lg text-slate-600">An interactive tool to understand and project your freelance income. Your entries are saved automatically.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">

            <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <h2 class="text-2xl font-bold mb-4 text-slate-900">Your Hourly Rate Setup</h2>
                
                 <div class="mb-4">
                    <label for="countrySelect" class="block text-sm font-medium text-slate-700">Select Country / Currency:</label>
                    <select id="countrySelect" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        <option value="SE">Sweden (SEK)</option>
                        <option value="GB">United Kingdom (GBP)</option>
                        <option value="US">United States (USD)</option>
                    </select>
                </div>
                
                <div id="usSalesTaxContainer" class="mb-4 hidden">
                    <label for="usSalesTaxInput" class="block text-sm font-medium text-slate-700">Your Local Sales Tax Rate (%):</label>
                    <input type="number" id="usSalesTaxInput" value="0" step="0.01" class="input-number-custom mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>


                <div class="mb-4">
                    <label for="grossSalaryInput" class="block text-sm font-medium text-slate-700">Desired Base "Gross Salary" (per hour):</label>
                    <input type="number" id="grossSalaryInput" value="0" step="0.01" class="input-number-custom mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>
                 <p class="text-sm text-slate-600 mb-1">Standard Hourly Rate: <span id="totalHourlyRateDisplay" class="font-bold">0</span></p>


                <div class="chart-container">
                    <canvas id="rateBreakdownChart"></canvas>
                </div>
                <ul id="chart-legend" class="mt-4 space-y-1 text-xs"></ul>
            </section>

            <section class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <h2 class="text-2xl font-bold mb-1 text-slate-900">Income Projector</h2>
                <p class="text-slate-600 mb-6">Adjust billable hours and shifts per month to see how they affect your income.</p>

                <div class="mb-6">
                    <label class="block font-medium text-slate-700">Total Billable Hours per Month: <span id="totalHoursValueText" class="font-bold text-blue-800">0.0</span></label>
                    <div class="flex items-center space-x-3 mt-2">
                        <input id="totalHoursSlider" type="range" min="0" max="200" value="0" step="0.1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        <input type="number" id="totalHoursNumberInput" min="0" max="200" value="0" step="0.1" class="input-number-custom w-24 px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-slate-800 mb-3">Premium Monthly Hours (OB):</h3>
                <p class="text-xs text-slate-500 mb-3 -mt-2">These are deducted from your total hours above.</p>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="ob50HoursInput" class="block text-sm font-medium text-slate-700">OB +50% (x1.5 Rate):</label>
                        <input type="number" id="ob50HoursInput" value="0" min="0" step="0.1" class="input-number-custom mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="ob70HoursInput" class="block text-sm font-medium text-slate-700">OB +70% (x1.7 Rate):</label>
                        <input type="number" id="ob70HoursInput" value="0" min="0" step="0.1" class="input-number-custom mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="ob100HoursInput" class="block text-sm font-medium text-slate-700">OB +100% (x2.0 Rate):</label>
                        <input type="number" id="ob100HoursInput" value="0" min="0" step="0.1" class="input-number-custom mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    </div>
                </div>

                <div class="bg-gray-100 p-3 rounded-md text-center mb-6">
                    <p class="text-sm text-gray-600">Calculated Standard Hours:</p>
                    <p id="standardHoursDisplay" class="text-xl font-bold text-gray-800">0.0</p>
                </div>

                <h3 class="text-lg font-semibold text-slate-800 mb-3">Monthly Transportation Compensation:</h3>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="shiftsWorkedInput" class="block text-sm font-medium text-slate-700">Number of Shifts Worked:</label>
                        <input type="number" id="shiftsWorkedInput" value="0" min="0" step="1" class="input-number-custom mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    </div>
                     <div class="bg-lime-50 p-3 rounded-lg text-center sm:mt-5">
                        <p class="text-sm text-lime-700">Transportation Income</p>
                        <p id="transportationIncomeDisplay" class="text-xl font-bold text-lime-800">0</p>
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-slate-800 mb-3 mt-8">Overall Projections (<span class="vat-label">Excluding MOMS</span>):</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 text-center">
                    <div class="bg-slate-100 p-4 rounded-lg">
                        <p class="text-sm text-slate-600">Total Invoiced (Monthly)</p>
                        <p id="monthlyInvoiced" class="text-2xl font-bold text-slate-900">0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <p class="text-sm text-blue-700">Total "Gross Salary" (Monthly)</p>
                        <p id="monthlySalary" class="text-2xl font-bold text-blue-800">0</p>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-lg">
                        <p class="text-sm text-slate-600">Total Invoiced (Yearly)</p>
                        <p id="yearlyInvoiced" class="text-2xl font-bold text-slate-900">0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <p class="text-sm text-blue-700">Total "Gross Salary" (Yearly)</p>
                        <p id="yearlySalary" class="text-2xl font-bold text-blue-800">0</p>
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-slate-800 mb-3 mt-8">Detailed Financial Breakdown (Monthly/Yearly):</h3>
                <div class="space-y-4 mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center bg-sky-50 p-3 rounded-lg">
                        <p class="sm:col-span-1 text-sm font-medium text-sky-700">Vacation Pay:</p>
                        <p id="monthlyVacationPay" class="text-lg font-bold text-sky-800 text-center sm:text-right">0</p>
                        <p id="yearlyVacationPay" class="text-lg font-bold text-sky-800 text-center sm:text-right">0</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center bg-cyan-50 p-3 rounded-lg">
                        <p class="sm:col-span-1 text-sm font-medium text-cyan-700">Pension Savings:</p>
                        <p id="monthlyPensionSavings" class="text-lg font-bold text-cyan-800 text-center sm:text-right">0</p>
                        <p id="yearlyPensionSavings" class="text-lg font-bold text-cyan-800 text-center sm:text-right">0</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center bg-fuchsia-50 p-3 rounded-lg">
                        <p class="sm:col-span-1 text-sm font-medium text-fuchsia-700">Sick Pay Buffer:</p>
                        <p id="monthlySickPay" class="text-lg font-bold text-fuchsia-800 text-center sm:text-right">0</p>
                        <p id="yearlySickPay" class="text-lg font-bold text-fuchsia-800 text-center sm:text-right">0</p>
                    </div>
                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center bg-indigo-50 p-3 rounded-lg">
                        <p class="sm:col-span-1 text-sm font-medium text-indigo-700">Business Overheads:</p>
                        <p id="monthlyOverheads" class="text-lg font-bold text-indigo-800 text-center sm:text-right">0</p>
                        <p id="yearlyOverheads" class="text-lg font-bold text-indigo-800 text-center sm:text-right">0</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center bg-green-50 p-3 rounded-lg">
                        <p class="sm:col-span-1 text-sm font-medium text-green-700">Business Profit Margin:</p>
                        <p id="monthlyProfitMargin" class="text-lg font-bold text-green-800 text-center sm:text-right">0</p>
                        <p id="yearlyProfitMargin" class="text-lg font-bold text-green-800 text-center sm:text-right">0</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center bg-orange-50 p-3 rounded-lg">
                        <p id="socialContributionLabel" class="sm:col-span-1 text-sm font-medium text-orange-700">Social Contributions:</p>
                        <p id="monthlySocialContributions" class="text-lg font-bold text-orange-800 text-center sm:text-right">0</p>
                        <p id="yearlySocialContributions" class="text-lg font-bold text-orange-800 text-center sm:text-right">0</p>
                    </div>
                </div>
                
                <h3 id="vatTitle" class="text-lg font-semibold text-slate-800 mb-3 mt-8">MOMS (VAT at 25%):</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 text-center">
                    <div class="bg-amber-50 p-4 rounded-lg">
                        <p class="vat-label text-sm text-amber-700">MOMS Amount (Monthly)</p>
                        <p id="monthlyMoms" class="text-2xl font-bold text-amber-800">0</p>
                    </div>
                    <div class="bg-amber-100 p-4 rounded-lg">
                        <p class="vat-incl-label text-sm text-amber-700">Total Invoiced incl. MOMS (Monthly)</p>
                        <p id="monthlyInvoicedWithMoms" class="text-2xl font-bold text-amber-900">0</p>
                    </div>
                     <div class="bg-amber-50 p-4 rounded-lg">
                        <p class="vat-label-yearly text-sm text-amber-700">MOMS Amount (Yearly)</p>
                        <p id="yearlyMoms" class="text-2xl font-bold text-amber-800">0</p>
                    </div>
                    <div class="bg-amber-100 p-4 rounded-lg">
                        <p class="vat-incl-label-yearly text-sm text-amber-700">Total Invoiced incl. MOMS (Yearly)</p>
                        <p id="yearlyInvoicedWithMoms" class="text-2xl font-bold text-amber-900">0</p>
                    </div>
                </div>

                <div class="mt-8">
                     <h3 class="text-lg font-semibold text-center text-slate-800 mb-2">Monthly Financial Composition (<span class="vat-label">Excl. MOMS</span> & Transportation)</h3>
                    <div class="comparison-chart-container">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </section>
        </main>

        <footer class="mt-10 bg-white p-6 rounded-xl shadow-md border border-slate-200">
            <h2 class="text-2xl font-bold text-slate-900 mb-4">Important Considerations</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="flex items-start space-x-3"><span class="text-2xl mt-1">📄</span><div><h3 class="font-semibold text-slate-800">Billable Hours</h3><p class="text-slate-600 text-sm">Income depends on actual billable hours. Plan for variability.</p></div></div>
                <div class="flex items-start space-x-3"><span class="text-2xl mt-1">💰</span><div><h3 class="font-semibold text-slate-800">Personal Tax</h3><p class="text-slate-600 text-sm">"Gross Salary" is pre-tax. Rates vary.</p></div></div>
                <div class="flex items-start space-x-3"><span class="text-2xl mt-1">✈️</span><div><h3 class="font-semibold text-slate-800">Travel Compensation</h3><p class="text-slate-600 text-sm">Separate from hourly rate and typically a reimbursement.</p></div></div>
                <div class="flex items-start space-x-3"><span class="text-2xl mt-1">🏥</span><div><h3 class="font-semibold text-slate-800">Sick Leave & Time Off</h3><p class="text-slate-600 text-sm">Self-employed cover initial sick days. Profit/Vacation pay build buffer.</p></div></div>
                <div class="flex items-start space-x-3"><span class="text-2xl mt-1">📈</span><div><h3 class="font-semibold text-slate-800">Variable Costs</h3><p class="text-slate-600 text-sm">"Business Overheads" is an estimate. Actual costs for insurance, accounting, etc., may vary.</p></div></div>
                <div class="flex items-start space-x-3"><span class="text-2xl mt-1">📋</span><div><h3 class="font-semibold text-slate-800">Admin Time</h3><p class="text-slate-600 text-sm">Hourly rate covers non-billable admin, marketing etc.</p></div></div>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const STORAGE_KEY = 'freelanceCalculatorInputs_v11_fixed'; 
            
            const countryConfigs = {
                'SE': {
                    currency: 'SEK',
                    transportPerShift: 79,
                    rates: {
                        vacationPay: 0.12, pension: 0.10, sickPay: 0.03,
                        overheads: 0.15, profit: 0.10,
                        socialSecurity: 0.2897, vat: 0.25
                    },
                    terms: {
                        socialContribution: 'Social Contributions (Egenavgifter)',
                        vatTitle: 'MOMS (VAT at 25%)',
                        vatLabel: 'MOMS',
                        vatInclLabel: 'incl. MOMS'
                    }
                },
                'GB': {
                    currency: 'GBP',
                    transportPerShift: 10,
                    rates: {
                        vacationPay: 0.1207, pension: 0.08, sickPay: 0.03,
                        overheads: 0.15, profit: 0.10,
                        socialSecurity: 0.09,
                        vat: 0.20
                    },
                    terms: {
                        socialContribution: 'National Insurance Contributions',
                        vatTitle: 'VAT (at 20%)',
                        vatLabel: 'VAT',
                        vatInclLabel: 'incl. VAT'
                    }
                },
                'US': {
                    currency: 'USD',
                    transportPerShift: 15,
                    rates: {
                        vacationPay: 0.08, pension: 0.08, sickPay: 0.03,
                        overheads: 0.15, profit: 0.10,
                        socialSecurity: 0.153,
                        vat: 0.00 
                    },
                     terms: {
                        socialContribution: 'Self-Employment Tax',
                        vatTitle: 'Sales Tax',
                        vatLabel: 'Tax',
                        vatInclLabel: 'incl. Tax'
                    }
                }
            };
            let currentConfig = countryConfigs['SE'];

            // State variables
            let state = {
                country: 'SE',
                usSalesTax: 0,
                baseGrossSalary: 0,
                totalBillableHours: 0,
                ob50: 0,
                ob70: 0,
                ob100: 0,
                shifts: 0
            };

            // Hourly component variables
            let hourlyRate = {
                baseSalary: 0, vacationPay: 0, pension: 0, sickPay: 0,
                overheads: 0, socialContributions: 0, profit: 0, total: 0
            };
            
            const rateDisplayInfo = { 
                labels: [
                    'Base "Gross Salary"', 'Vacation Pay', 'Pension Savings', 'Sick Pay Buffer', 'Business Overheads',
                    'Social Contributions', 'Profit Margin'
                ],
            };
            
            const chartColors = { 
                salary: 'rgba(30, 64, 175, 0.9)', vacation: 'rgba(56, 189, 248, 0.9)', 
                pension: 'rgba(14, 165, 233, 0.9)', sickPay: 'rgba(217, 70, 239, 0.9)',
                overheads: 'rgba(79, 70, 229, 0.9)', social: 'rgba(249, 115, 22, 0.9)',   
                profit: 'rgba(34, 197, 94, 0.9)'
            };
            const donutBackgroundColors = [chartColors.salary, chartColors.vacation, chartColors.pension, chartColors.sickPay, chartColors.overheads, chartColors.social, chartColors.profit];
            
            const grossSalaryInputEl = document.getElementById('grossSalaryInput');
            const totalHourlyRateDisplayEl = document.getElementById('totalHourlyRateDisplay');
            const legendContainerEl = document.getElementById('chart-legend');
            const totalHoursSliderEl = document.getElementById('totalHoursSlider');
            const totalHoursNumberInputEl = document.getElementById('totalHoursNumberInput');
            const totalHoursValueTextEl = document.getElementById('totalHoursValueText');
            const standardHoursDisplayEl = document.getElementById('standardHoursDisplay');
            const ob50HoursInputEl = document.getElementById('ob50HoursInput');
            const ob70HoursInputEl = document.getElementById('ob70HoursInput');
            const ob100HoursInputEl = document.getElementById('ob100HoursInput');
            const shiftsWorkedInputEl = document.getElementById('shiftsWorkedInput');
            const transportationIncomeDisplayEl = document.getElementById('transportationIncomeDisplay');
            const monthlyInvoicedEl = document.getElementById('monthlyInvoiced');
            const monthlySalaryEl = document.getElementById('monthlySalary');
            const yearlyInvoicedEl = document.getElementById('yearlyInvoiced');
            const yearlySalaryEl = document.getElementById('yearlySalary');
            const monthlyVacationPayEl = document.getElementById('monthlyVacationPay');
            const yearlyVacationPayEl = document.getElementById('yearlyVacationPay');
            const monthlyPensionSavingsEl = document.getElementById('monthlyPensionSavings');
            const yearlyPensionSavingsEl = document.getElementById('yearlyPensionSavings');
            const monthlySickPayEl = document.getElementById('monthlySickPay');
            const yearlySickPayEl = document.getElementById('yearlySickPay');
            const monthlyOverheadsEl = document.getElementById('monthlyOverheads');
            const yearlyOverheadsEl = document.getElementById('yearlyOverheads');
            const monthlyProfitMarginEl = document.getElementById('monthlyProfitMargin');
            const yearlyProfitMarginEl = document.getElementById('yearlyProfitMargin');
            const monthlySocialContributionsEl = document.getElementById('monthlySocialContributions');
            const yearlySocialContributionsEl = document.getElementById('yearlySocialContributions');
            const monthlyMomsEl = document.getElementById('monthlyMoms');
            const yearlyMomsEl = document.getElementById('yearlyMoms');
            const monthlyInvoicedWithMomsEl = document.getElementById('monthlyInvoicedWithMoms');
            const yearlyInvoicedWithMomsEl = document.getElementById('yearlyInvoicedWithMoms');
            const socialContributionLabelEl = document.getElementById('socialContributionLabel');
            const vatTitleEl = document.getElementById('vatTitle');
            const countrySelectEl = document.getElementById('countrySelect');
            const usSalesTaxContainerEl = document.getElementById('usSalesTaxContainer');
            const usSalesTaxInputEl = document.getElementById('usSalesTaxInput');
            
            const allInputEls = {
                country: countrySelectEl, usSalesTax: usSalesTaxInputEl, baseGrossSalary: grossSalaryInputEl,
                totalBillableHours: totalHoursNumberInputEl, ob50: ob50HoursInputEl, ob70: ob70HoursInputEl,
                ob100: ob100HoursInputEl, shifts: shiftsWorkedInputEl
            };

            const ctxBreakdown = document.getElementById('rateBreakdownChart').getContext('2d');
            const breakdownChart = new Chart(ctxBreakdown, {
                type: 'doughnut', data: { labels: rateDisplayInfo.labels, datasets: [{
                    label: 'SEK/hour', data: [], backgroundColor: donutBackgroundColors,
                    borderWidth: 1, hoverOffset: 10 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: {
                    callbacks: { label: (ctx) => {
                         const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                         const percentage = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                         return `${ctx.label}: ${formatCurrency(ctx.raw, false)} (${percentage}%)`;
                    }}
                }}, cutout: '60%'}
            });

            const ctxComparison = document.getElementById('comparisonChart').getContext('2d');
            const comparisonChart = new Chart(ctxComparison, {
                type: 'bar',
                data: {
                    labels: ['Monthly Composition'],
                    datasets: [
                        { label: 'Total "Gross Salary"', data: [0], backgroundColor: chartColors.salary },
                        { label: 'Vacation Pay', data: [0], backgroundColor: chartColors.vacation },
                        { label: 'Pension Savings', data: [0], backgroundColor: chartColors.pension },
                        { label: 'Sick Pay Buffer', data: [0], backgroundColor: chartColors.sickPay },
                        { label: 'Business Overheads', data: [0], backgroundColor: chartColors.overheads },
                        { label: 'Social Contributions', data: [0], backgroundColor: chartColors.social },
                        { label: 'Business Profit Margin', data: [0], backgroundColor: chartColors.profit }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'x',
                    scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: (value) => value / 1000 + 'k' } } },
                    plugins: { legend: { position: 'bottom', labels:{boxWidth:15, padding:10} }, tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` } } }
                }
            });

            function saveState() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            }

            function loadState() {
                const savedStateJSON = localStorage.getItem(STORAGE_KEY);
                if (savedStateJSON) {
                    const savedState = JSON.parse(savedStateJSON);
                    Object.assign(state, savedState);
                } 
                Object.keys(state).forEach(key => {
                    const el = allInputEls[key];
                    if (el) {
                        el.value = state[key];
                    }
                });
                totalHoursSliderEl.value = state.totalBillableHours;
            }
            
            function updateUI() {
                // Update config based on state
                currentConfig = countryConfigs[state.country];
                updateUIText();
                
                // Recalculate everything based on current state
                calculateStandardHourlyRateComponents();
                updateProjections();
            }

            function updateUIText() {
                socialContributionLabelEl.textContent = currentConfig.terms.socialContribution + ':';
                vatTitleEl.textContent = currentConfig.terms.vatTitle;
                document.querySelectorAll('.vat-label').forEach(el => el.textContent = `${currentConfig.terms.vatLabel} Amount (Monthly)`);
                document.querySelectorAll('.vat-incl-label').forEach(el => el.textContent = `Total Invoiced incl. ${currentConfig.terms.vatLabel} (Monthly)`);
                document.querySelectorAll('.vat-label-yearly').forEach(el => el.textContent = `${currentConfig.terms.vatLabel} Amount (Yearly)`);
                document.querySelectorAll('.vat-incl-label-yearly').forEach(el => el.textContent = `Total Invoiced incl. ${currentConfig.terms.vatLabel} (Yearly)`);
                document.querySelectorAll('span.vat-label').forEach(el => el.textContent = `Excluding ${currentConfig.terms.vatLabel}`);
                
                usSalesTaxContainerEl.classList.toggle('hidden', state.country !== 'US');
            }

            function calculateStandardHourlyRateComponents() {
                hourlyRate.baseSalary = state.baseGrossSalary;
                hourlyRate.vacationPay = hourlyRate.baseSalary * currentConfig.rates.vacationPay;
                hourlyRate.pension = hourlyRate.baseSalary * currentConfig.rates.pension;
                hourlyRate.sickPay = hourlyRate.baseSalary * currentConfig.rates.sickPay;
                hourlyRate.overheads = hourlyRate.baseSalary * currentConfig.rates.overheads;
                const subtotal = hourlyRate.baseSalary + hourlyRate.vacationPay + hourlyRate.pension + hourlyRate.sickPay + hourlyRate.overheads;
                const adjustedForEgen = subtotal / (1 - currentConfig.rates.socialSecurity);
                hourlyRate.socialContributions = adjustedForEgen - subtotal;
                hourlyRate.profit = adjustedForEgen * currentConfig.rates.profit;
                hourlyRate.total = adjustedForEgen + hourlyRate.profit;

                const chartData = [hourlyRate.baseSalary, hourlyRate.vacationPay, hourlyRate.pension, hourlyRate.sickPay, hourlyRate.overheads, hourlyRate.socialContributions, hourlyRate.profit];
                breakdownChart.data.datasets[0].data = chartData;
                breakdownChart.update();
                updateLegend(chartData);
            }
            
            function updateProjections() {
                let ob50Hours = state.ob50, ob70Hours = state.ob70, ob100Hours = state.ob100;
                let totalOB = ob50Hours + ob70Hours + ob100Hours;
                if (totalOB > state.totalBillableHours) {
                    const overage = totalOB - state.totalBillableHours;
                    const inputs = [{el: ob100HoursInputEl, key: 'ob100'}, {el: ob70HoursInputEl, key: 'ob70'}, {el: ob50HoursInputEl, key: 'ob50'}];
                    let remainingOverage = overage;
                    for (const {el, key} of inputs) {
                        let currentVal = state[key];
                        if (currentVal > 0) {
                            const reduction = Math.min(currentVal, remainingOverage);
                            state[key] = currentVal - reduction;
                            el.value = state[key].toFixed(1);
                            remainingOverage -= reduction;
                            if (remainingOverage <= 0) break;
                        }
                    }
                }
                ob50Hours = state.ob50; ob70Hours = state.ob70; ob100Hours = state.ob100;
                const standardHours = Math.max(0, state.totalBillableHours - (ob50Hours + ob70Hours + ob100Hours));
                
                const monthlyTransportationIncome = state.shifts * currentConfig.transportPerShift;
                
                let totalMonthlyGrossSalary = 0, totalMonthlyVacationPay = 0, totalMonthlyPensionSavings = 0, totalMonthlySickPay = 0;
                let totalMonthlyOverheads = 0, totalMonthlyEgenavgifter = 0, totalMonthlyProfit = 0;

                totalMonthlyGrossSalary += standardHours * hourlyRate.baseSalary;
                totalMonthlyVacationPay += standardHours * hourlyRate.vacationPay;
                totalMonthlyPensionSavings += standardHours * hourlyRate.pension;
                totalMonthlySickPay += standardHours * hourlyRate.sickPay;
                totalMonthlyOverheads += standardHours * hourlyRate.overheads;
                totalMonthlyEgenavgifter += standardHours * hourlyRate.socialContributions;
                totalMonthlyProfit += standardHours * hourlyRate.profit;
                
                const multipliers = [{ hours: ob50Hours, m: 1.5 }, { hours: ob70Hours, m: 1.7 }, { hours: ob100Hours, m: 2.0 }];
                multipliers.forEach(({hours, m}) => {
                    if (hours > 0) {
                        totalMonthlyGrossSalary += hours * hourlyRate.baseSalary * m;
                        totalMonthlyVacationPay += hours * hourlyRate.vacationPay * m;
                        totalMonthlyPensionSavings += hours * hourlyRate.pension * m;
                        totalMonthlySickPay += hours * hourlyRate.sickPay * m;
                        totalMonthlyOverheads += hours * hourlyRate.overheads * m;
                        totalMonthlyEgenavgifter += hours * hourlyRate.socialContributions * m;
                        totalMonthlyProfit += hours * hourlyRate.profit * m;
                    }
                });

                const totalMonthlyInvoicedExclMoms = totalMonthlyGrossSalary + totalMonthlyVacationPay + totalMonthlyPensionSavings + totalMonthlySickPay + totalMonthlyOverheads + totalMonthlyEgenavgifter + totalMonthlyProfit + monthlyTransportationIncome;
                
                let effectiveVatRate = currentConfig.rates.vat;
                if (currentConfig.currency === 'USD') {
                    effectiveVatRate = state.usSalesTax / 100;
                }
                const monthlyMomsVal = totalMonthlyInvoicedExclMoms * effectiveVatRate;
                
                renderDOMValues({
                    standardHours, monthlyTransportationIncome, totalMonthlyInvoicedExclMoms,
                    totalMonthlyGrossSalary, totalMonthlyVacationPay, totalMonthlyPensionSavings, totalMonthlySickPay,
                    totalMonthlyOverheads, totalMonthlyEgenavgifter, totalMonthlyProfit, monthlyMomsVal
                });
            }
            
            function renderDOMValues(data) {
                totalHoursValueTextEl.textContent = state.totalBillableHours.toFixed(1);
                standardHoursDisplayEl.textContent = data.standardHours.toFixed(1);
                totalHourlyRateDisplayEl.textContent = `${formatCurrency(hourlyRate.total, false)}`;
                transportationIncomeDisplayEl.textContent = formatCurrency(data.monthlyTransportationIncome);
                
                monthlyInvoicedEl.textContent = formatCurrency(data.totalMonthlyInvoicedExclMoms);
                yearlyInvoicedEl.textContent = formatCurrency(data.totalMonthlyInvoicedExclMoms * 12);
                monthlySalaryEl.textContent = formatCurrency(data.totalMonthlyGrossSalary);
                yearlySalaryEl.textContent = formatCurrency(data.totalMonthlyGrossSalary * 12);
                monthlyVacationPayEl.textContent = formatCurrency(data.totalMonthlyVacationPay);
                yearlyVacationPayEl.textContent = formatCurrency(data.totalMonthlyVacationPay * 12);
                monthlyPensionSavingsEl.textContent = formatCurrency(data.totalMonthlyPensionSavings);
                yearlyPensionSavingsEl.textContent = formatCurrency(data.totalMonthlyPensionSavings * 12);
                monthlySickPayEl.textContent = formatCurrency(data.totalMonthlySickPay);
                yearlySickPayEl.textContent = formatCurrency(data.totalMonthlySickPay * 12);
                monthlyOverheadsEl.textContent = formatCurrency(data.totalMonthlyOverheads);
                yearlyOverheadsEl.textContent = formatCurrency(data.totalMonthlyOverheads * 12);
                monthlyProfitMarginEl.textContent = formatCurrency(data.totalMonthlyProfit);
                yearlyProfitMarginEl.textContent = formatCurrency(data.totalMonthlyProfit * 12);
                monthlySocialContributionsEl.textContent = formatCurrency(data.totalMonthlyEgenavgifter);
                yearlySocialContributionsEl.textContent = formatCurrency(data.totalMonthlyEgenavgifter * 12);

                monthlyMomsEl.textContent = formatCurrency(data.monthlyMomsVal);
                yearlyMomsEl.textContent = formatCurrency(data.monthlyMomsVal * 12);
                monthlyInvoicedWithMomsEl.textContent = formatCurrency(data.totalMonthlyInvoicedExclMoms + data.monthlyMomsVal);
                yearlyInvoicedWithMomsEl.textContent = formatCurrency((data.totalMonthlyInvoicedExclMoms + data.monthlyMomsVal) * 12);

                comparisonChart.data.datasets[0].data[0] = data.totalMonthlyGrossSalary;
                comparisonChart.data.datasets[1].data[0] = data.totalMonthlyVacationPay;
                comparisonChart.data.datasets[2].data[0] = data.totalMonthlyPensionSavings;
                comparisonChart.data.datasets[3].data[0] = data.totalMonthlySickPay;
                comparisonChart.data.datasets[4].data[0] = data.totalMonthlyOverheads;
                comparisonChart.data.datasets[5].data[0] = data.totalMonthlyEgenavgifter;
                comparisonChart.data.datasets[6].data[0] = data.totalMonthlyProfit;
                comparisonChart.update();
            }
            
            function updateLegend(chartData) {
                legendContainerEl.innerHTML = ''; 
                rateDisplayInfo.labels.forEach((label, index) => {
                    const li = document.createElement('li'); li.className = 'flex items-center';
                    const value = chartData[index] || 0; 
                    const percentage = hourlyRate.total > 0 ? ((value / hourlyRate.total) * 100).toFixed(1) : 0;
                    li.innerHTML = `<span class="w-3 h-3 rounded-full mr-2" style="background-color: ${donutBackgroundColors[index]}"></span>
                                    <span class="flex-grow">${label}</span>
                                    <span class="ml-auto font-medium text-right">${value.toFixed(2)} (${percentage}%)</span>`;
                    legendContainerEl.appendChild(li);
                });
            }
            const formatCurrency = (value, includeCurrencyCode = true) => {
                return new Intl.NumberFormat(undefined, {
                    style: 'currency', currency: currentConfig.currency, 
                    minimumFractionDigits: 0, maximumFractionDigits: 0
                }).format(value);
            };

            function initialize() {
                loadState();
                
                Object.keys(allInputEls).forEach(key => {
                    const el = allInputEls[key];
                    el.addEventListener('input', () => {
                        if (el.type === 'select-one') {
                            state[key] = el.value;
                        } else {
                            const parsedValue = parseFloat(el.value);
                            state[key] = isNaN(parsedValue) ? 0 : parsedValue;
                        }
                        
                        // Sync slider and number input for total hours
                        if (el.id === 'totalHoursSlider' || el.id === 'totalHoursNumberInput') {
                            totalHoursSliderEl.value = state.totalBillableHours;
                            totalHoursNumberInputEl.value = state.totalBillableHours;
                        }
                        
                        updateUI();
                        saveState();
                    });
                });
                updateUI();
            }

            initialize();
        });
    </script>
</body>
</html>
