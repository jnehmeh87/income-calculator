<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freelance Rate & Income Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Nordic Calm -->
    <!-- Application Structure Plan: Dashboard. Module 1: Rate definition based on user-specified formula. Module 2: Income projection (standard hours auto-adjust with OB hours, transportation, detailed financial breakdown, MOMS). OB rates scale all components of standard rate. Standard hours allow decimals. All inputs are saved to and loaded from local storage. Module 3: Considerations. -->
    <!-- Visualization & Content Choices: Rate Breakdown -> Donut Chart + Input (legend includes %). Income Projections -> Sliders/Inputs + Dynamic Text + Stacked Bar Chart. OB Hours -> Inputs with % premium, auto-deduct from standard. Transportation -> Input for shifts. MOMS -> Calculated display. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px; 
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        .comparison-chart-container { 
            position: relative;
            width: 100%;
            max-width: 600px; 
            margin-left: auto;
            margin-right: auto;
            height: 300px; 
            max-height: 350px;
        }
        @media (max-width: 640px) {
            .chart-container {
                height: 300px;
            }
            .comparison-chart-container {
                height: 250px;
            }
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #1e40af; 
            cursor: pointer;
            border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #1e40af; 
            cursor: pointer;
            border-radius: 50%;
        }
        .input-number-custom {
            -moz-appearance: textfield;
        }
        .input-number-custom::-webkit-outer-spin-button,
        .input-number-custom::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Freelance Rate & Income Calculator</h1>
            <p class="mt-2 text-lg text-slate-600">An interactive tool to understand and project your freelance income. Your entries are saved automatically.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">

            <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <h2 class="text-2xl font-bold mb-1 text-slate-900">Your Hourly Rate Setup</h2>
                <p class="text-slate-600 mb-4">Define your desired base gross salary to see how your standard hourly rate is structured.</p>
                
                <div class="mb-4">
                    <label for="grossSalaryInput" class="block text-sm font-medium text-slate-700">Desired Base "Gross Salary" (SEK/hour):</label>
                    <input type="number" id="grossSalaryInput" value="121.61" step="0.01" class="input-number-custom mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>
                 <p class="text-sm text-slate-600 mb-1">Standard Hourly Rate: <span id="totalHourlyRateDisplay" class="font-bold">275</span> SEK</p>


                <div class="chart-container">
                    <canvas id="rateBreakdownChart"></canvas>
                </div>
                <ul id="chart-legend" class="mt-4 space-y-1 text-xs"></ul>
            </section>

            <section class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <h2 class="text-2xl font-bold mb-1 text-slate-900">Income Projector</h2>
                <p class="text-slate-600 mb-6">Adjust billable hours and shifts per month to see how they affect your income.</p>

                <div class="mb-6">
                    <label class="block font-medium text-slate-700">Standard Billable Hours per Month: <span id="hoursValueText" class="font-bold text-blue-800">82.0</span></label>
                    <div class="flex items-center space-x-3 mt-2">
                        <input id="hoursSlider" type="range" min="0" max="200" value="82" step="0.1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        <input type="number" id="hoursNumberInput" min="0" max="200" value="82" step="0.1" class="input-number-custom w-24 px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-slate-800 mb-3">Premium Monthly Hours (OB):</h3>
                <p class="text-xs text-slate-500 mb-3 -mt-2">Adding OB hours will deduct from Standard Billable Hours. Rate for these hours is Standard Rate x Multiplier.</p>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="ob50HoursInput" class="block text-sm font-medium text-slate-700">OB +50% (x1.5 Rate):</label>
                        <input type="number" id="ob50HoursInput" value="0" min="0" step="0.1" class="input-number-custom mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="ob70HoursInput" class="block text-sm font-medium text-slate-700">OB +70% (x1.7 Rate):</label>
                        <input type="number" id="ob70HoursInput" value="0" min="0" step="0.1" class="input-number-custom mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="ob100HoursInput" class="block text-sm font-medium text-slate-700">OB +100% (x2.0 Rate):</label>
                        <input type="number" id="ob100HoursInput" value="24" min="0" step="0.1" class="input-number-custom mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-slate-800 mb-3">Monthly Transportation Compensation:</h3>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="shiftsWorkedInput" class="block text-sm font-medium text-slate-700">Number of Shifts Worked:</label>
                        <input type="number" id="shiftsWorkedInput" value="0" min="0" step="1" class="input-number-custom mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                    </div>
                     <div class="bg-lime-50 p-3 rounded-lg text-center sm:mt-5">
                        <p class="text-sm text-lime-700">Transportation Income</p>
                        <p id="transportationIncomeDisplay" class="text-xl font-bold text-lime-800">0 SEK</p>
                    </div>
                </div>


                <h3 class="text-lg font-semibold text-slate-800 mb-3 mt-8">Overall Projections (Excluding MOMS):</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 text-center">
                    <div class="bg-slate-100 p-4 rounded-lg">
                        <p class="text-sm text-slate-600">Total Invoiced (Monthly)</p>
                        <p id="monthlyInvoiced" class="text-2xl font-bold text-slate-900">0 SEK</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <p class="text-sm text-blue-700">Total "Gross Salary" (Monthly)</p>
                        <p id="monthlySalary" class="text-2xl font-bold text-blue-800">0 SEK</p>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-lg">
                        <p class="text-sm text-slate-600">Total Invoiced (Yearly)</p>
                        <p id="yearlyInvoiced" class="text-2xl font-bold text-slate-900">0 SEK</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <p class="text-sm text-blue-700">Total "Gross Salary" (Yearly)</p>
                        <p id="yearlySalary" class="text-2xl font-bold text-blue-800">0 SEK</p>
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-slate-800 mb-3 mt-8">Detailed Financial Breakdown (Monthly/Yearly):</h3>
                <div class="space-y-4 mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center bg-sky-50 p-3 rounded-lg">
                        <p class="sm:col-span-1 text-sm font-medium text-sky-700">Vacation Pay:</p>
                        <p id="monthlyVacationPay" class="text-lg font-bold text-sky-800 text-center sm:text-right">0 SEK</p>
                        <p id="yearlyVacationPay" class="text-lg font-bold text-sky-800 text-center sm:text-right">0 SEK</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center bg-cyan-50 p-3 rounded-lg">
                        <p class="sm:col-span-1 text-sm font-medium text-cyan-700">Pension Savings:</p>
                        <p id="monthlyPensionSavings" class="text-lg font-bold text-cyan-800 text-center sm:text-right">0 SEK</p>
                        <p id="yearlyPensionSavings" class="text-lg font-bold text-cyan-800 text-center sm:text-right">0 SEK</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center bg-fuchsia-50 p-3 rounded-lg">
                        <p class="sm:col-span-1 text-sm font-medium text-fuchsia-700">Sick Pay Buffer:</p>
                        <p id="monthlySickPay" class="text-lg font-bold text-fuchsia-800 text-center sm:text-right">0 SEK</p>
                        <p id="yearlySickPay" class="text-lg font-bold text-fuchsia-800 text-center sm:text-right">0 SEK</p>
                    </div>
                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center bg-indigo-50 p-3 rounded-lg">
                        <p class="sm:col-span-1 text-sm font-medium text-indigo-700">Business Overheads:</p>
                        <p id="monthlyOverheads" class="text-lg font-bold text-indigo-800 text-center sm:text-right">0 SEK</p>
                        <p id="yearlyOverheads" class="text-lg font-bold text-indigo-800 text-center sm:text-right">0 SEK</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center bg-green-50 p-3 rounded-lg">
                        <p class="sm:col-span-1 text-sm font-medium text-green-700">Business Profit Margin:</p>
                        <p id="monthlyProfitMargin" class="text-lg font-bold text-green-800 text-center sm:text-right">0 SEK</p>
                        <p id="yearlyProfitMargin" class="text-lg font-bold text-green-800 text-center sm:text-right">0 SEK</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center bg-orange-50 p-3 rounded-lg">
                        <p class="sm:col-span-1 text-sm font-medium text-orange-700">Social Contributions:</p>
                        <p id="monthlySocialContributions" class="text-lg font-bold text-orange-800 text-center sm:text-right">0 SEK</p>
                        <p id="yearlySocialContributions" class="text-lg font-bold text-orange-800 text-center sm:text-right">0 SEK</p>
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold text-slate-800 mb-3 mt-8">MOMS (VAT at 25%):</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 text-center">
                    <div class="bg-amber-50 p-4 rounded-lg">
                        <p class="text-sm text-amber-700">MOMS Amount (Monthly)</p>
                        <p id="monthlyMoms" class="text-2xl font-bold text-amber-800">0 SEK</p>
                    </div>
                    <div class="bg-amber-100 p-4 rounded-lg">
                        <p class="text-sm text-amber-700">Total Invoiced incl. MOMS (Monthly)</p>
                        <p id="monthlyInvoicedWithMoms" class="text-2xl font-bold text-amber-900">0 SEK</p>
                    </div>
                     <div class="bg-amber-50 p-4 rounded-lg">
                        <p class="text-sm text-amber-700">MOMS Amount (Yearly)</p>
                        <p id="yearlyMoms" class="text-2xl font-bold text-amber-800">0 SEK</p>
                    </div>
                    <div class="bg-amber-100 p-4 rounded-lg">
                        <p class="text-sm text-amber-700">Total Invoiced incl. MOMS (Yearly)</p>
                        <p id="yearlyInvoicedWithMoms" class="text-2xl font-bold text-amber-900">0 SEK</p>
                    </div>
                </div>

                <div class="mt-8">
                     <h3 class="text-lg font-semibold text-center text-slate-800 mb-2">Monthly Financial Composition (Excl. MOMS & Transportation)</h3>
                    <div class="comparison-chart-container">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </section>
        </main>

        <footer class="mt-10 bg-white p-6 rounded-xl shadow-md border border-slate-200">
            <h2 class="text-2xl font-bold text-slate-900 mb-4">Important Considerations</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="flex items-start space-x-3"><span class="text-2xl mt-1">📄</span><div><h3 class="font-semibold text-slate-800">Billable Hours</h3><p class="text-slate-600 text-sm">Income depends on actual billable hours. Plan for variability.</p></div></div>
                <div class="flex items-start space-x-3"><span class="text-2xl mt-1">💰</span><div><h3 class="font-semibold text-slate-800">Personal Tax</h3><p class="text-slate-600 text-sm">"Gross Salary" is pre-tax. Rates vary.</p></div></div>
                <div class="flex items-start space-x-3"><span class="text-2xl mt-1">✈️</span><div><h3 class="font-semibold text-slate-800">Travel Compensation</h3><p class="text-slate-600 text-sm">Separate from hourly rate and typically a reimbursement.</p></div></div>
                <div class="flex items-start space-x-3"><span class="text-2xl mt-1">🏥</span><div><h3 class="font-semibold text-slate-800">Sick Leave & Time Off</h3><p class="text-slate-600 text-sm">Self-employed cover initial sick days. Profit/Vacation pay build buffer.</p></div></div>
                <div class="flex items-start space-x-3"><span class="text-2xl mt-1">📈</span><div><h3 class="font-semibold text-slate-800">Variable Costs</h3><p class="text-slate-600 text-sm">"Business Overheads" is an estimate. Actual costs for insurance, accounting, etc., may vary.</p></div></div>
                <div class="flex items-start space-x-3"><span class="text-2xl mt-1">📋</span><div><h3 class="font-semibold text-slate-800">Admin Time</h3><p class="text-slate-600 text-sm">Hourly rate covers non-billable admin, marketing etc.</p></div></div>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const STORAGE_KEY = 'freelanceCalculatorInputs_v5'; 
            
            const vacationPayPercentage = 0.12; 
            const pensionSavingsPercentage = 0.10; 
            const sickPayPercentage = 0.03;
            const businessOverheadsPercentage = 0.15;
            const profitMarginPercentage = 0.10;

            const egenavgifterRate = 0.2897; 
            const momsRate = 0.25;
            const transportPerShift = 79;

            let currentBaseSalaryEquivalentRate = 0;
            let currentStandardTotalHourlyRate = 0; 
            let currentStandardHourlyVacationPay = 0;
            let currentStandardHourlyPensionSavings = 0;
            let currentStandardHourlySickPay = 0;
            let currentStandardHourlyOverheads = 0;
            let currentStandardHourlyEgenavgifter = 0;
            let currentStandardHourlyProfitMargin = 0;
            
            let previousTotalOBHoursGlobal = 0;

            const rateDisplayInfo = { 
                labels: [
                    'Base "Gross Salary"', 'Vacation Pay', 'Pension Savings', 'Sick Pay Buffer', 'Business Overheads',
                    'Social Contributions', 'Profit Margin'
                ],
                currentValues: [] 
            };
            
            const chartColors = { 
                salary: 'rgba(30, 64, 175, 0.9)', vacation: 'rgba(56, 189, 248, 0.9)', 
                pension: 'rgba(14, 165, 233, 0.9)', sickPay: 'rgba(217, 70, 239, 0.9)',
                overheads: 'rgba(79, 70, 229, 0.9)', social: 'rgba(249, 115, 22, 0.9)',   
                profit: 'rgba(34, 197, 94, 0.9)'
            };
            const donutBackgroundColors = [chartColors.salary, chartColors.vacation, chartColors.pension, chartColors.sickPay, chartColors.overheads, chartColors.social, chartColors.profit];
            
            const grossSalaryInputEl = document.getElementById('grossSalaryInput');
            const totalHourlyRateDisplayEl = document.getElementById('totalHourlyRateDisplay');
            const legendContainerEl = document.getElementById('chart-legend');
            const hoursSliderEl = document.getElementById('hoursSlider');
            const hoursNumberInputEl = document.getElementById('hoursNumberInput');
            const hoursValueTextEl = document.getElementById('hoursValueText');
            const ob50HoursInputEl = document.getElementById('ob50HoursInput');
            const ob70HoursInputEl = document.getElementById('ob70HoursInput');
            const ob100HoursInputEl = document.getElementById('ob100HoursInput');
            const shiftsWorkedInputEl = document.getElementById('shiftsWorkedInput');
            const transportationIncomeDisplayEl = document.getElementById('transportationIncomeDisplay');
            const monthlyInvoicedEl = document.getElementById('monthlyInvoiced');
            const monthlySalaryEl = document.getElementById('monthlySalary');
            const yearlyInvoicedEl = document.getElementById('yearlyInvoiced');
            const yearlySalaryEl = document.getElementById('yearlySalary');
            const monthlyVacationPayEl = document.getElementById('monthlyVacationPay');
            const yearlyVacationPayEl = document.getElementById('yearlyVacationPay');
            const monthlyPensionSavingsEl = document.getElementById('monthlyPensionSavings');
            const yearlyPensionSavingsEl = document.getElementById('yearlyPensionSavings');
            const monthlySickPayEl = document.getElementById('monthlySickPay');
            const yearlySickPayEl = document.getElementById('yearlySickPay');
            const monthlyOverheadsEl = document.getElementById('monthlyOverheads');
            const yearlyOverheadsEl = document.getElementById('yearlyOverheads');
            const monthlyProfitMarginEl = document.getElementById('monthlyProfitMargin');
            const yearlyProfitMarginEl = document.getElementById('yearlyProfitMargin');
            const monthlySocialContributionsEl = document.getElementById('monthlySocialContributions');
            const yearlySocialContributionsEl = document.getElementById('yearlySocialContributions');
            const monthlyMomsEl = document.getElementById('monthlyMoms');
            const yearlyMomsEl = document.getElementById('yearlyMoms');
            const monthlyInvoicedWithMomsEl = document.getElementById('monthlyInvoicedWithMoms');
            const yearlyInvoicedWithMomsEl = document.getElementById('yearlyInvoicedWithMoms');

            const ctxBreakdown = document.getElementById('rateBreakdownChart').getContext('2d');
            const breakdownChart = new Chart(ctxBreakdown, {
                type: 'doughnut', data: { labels: rateDisplayInfo.labels, datasets: [{
                    label: 'SEK/hour', data: [], backgroundColor: donutBackgroundColors,
                    borderWidth: 1, hoverOffset: 10 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: {
                    callbacks: { label: (ctx) => {
                         const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                         const percentage = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                         return `${ctx.label}: ${ctx.raw.toFixed(2)} SEK (${percentage}%)`;
                    }}
                }}, cutout: '60%'}
            });

            const ctxComparison = document.getElementById('comparisonChart').getContext('2d');
            const comparisonChart = new Chart(ctxComparison, {
                type: 'bar',
                data: {
                    labels: ['Monthly Composition'],
                    datasets: [
                        { label: 'Total "Gross Salary"', data: [0], backgroundColor: chartColors.salary },
                        { label: 'Vacation Pay', data: [0], backgroundColor: chartColors.vacation },
                        { label: 'Pension Savings', data: [0], backgroundColor: chartColors.pension },
                        { label: 'Sick Pay Buffer', data: [0], backgroundColor: chartColors.sickPay },
                        { label: 'Business Overheads', data: [0], backgroundColor: chartColors.overheads },
                        { label: 'Social Contributions', data: [0], backgroundColor: chartColors.social },
                        { label: 'Business Profit Margin', data: [0], backgroundColor: chartColors.profit }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'x',
                    scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: (value) => value / 1000 + 'k' } } },
                    plugins: { legend: { position: 'bottom', labels:{boxWidth:15, padding:10} }, tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` } } }
                }
            });

            function saveInputs() {
                const inputsToSave = {
                    grossSalary: grossSalaryInputEl.value, standardHours: hoursNumberInputEl.value,
                    ob50: ob50HoursInputEl.value, ob70: ob70HoursInputEl.value, ob100: ob100HoursInputEl.value,
                    shifts: shiftsWorkedInputEl.value
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(inputsToSave));
            }

            function loadInputs() {
                const savedInputsJSON = localStorage.getItem(STORAGE_KEY);
                if (savedInputsJSON) {
                    const savedInputs = JSON.parse(savedInputsJSON);
                    grossSalaryInputEl.value = savedInputs.grossSalary || "0";
                    hoursNumberInputEl.value = savedInputs.standardHours || "0";
                    ob50HoursInputEl.value = savedInputs.ob50 || "0";
                    ob70HoursInputEl.value = savedInputs.ob70 || "0";
                    ob100HoursInputEl.value = savedInputs.ob100 || "0";
                    shiftsWorkedInputEl.value = savedInputs.shifts || "0";
                } else {
                    [grossSalaryInputEl, hoursNumberInputEl, ob50HoursInputEl, ob70HoursInputEl, ob100HoursInputEl, shiftsWorkedInputEl].forEach(el => el.value = "0");
                }
                const loadedHours = parseFloat(hoursNumberInputEl.value) || 0;
                hoursSliderEl.value = loadedHours;
                hoursValueTextEl.textContent = loadedHours.toFixed(1);
            }

            function calculateStandardHourlyRateComponents(baseGrossSalary) {
                currentBaseSalaryEquivalentRate = parseFloat(baseGrossSalary) || 0;
                // B, C, D, E based on A
                currentStandardHourlyVacationPay = currentBaseSalaryEquivalentRate * vacationPayPercentage;
                currentStandardHourlyPensionSavings = currentBaseSalaryEquivalentRate * pensionSavingsPercentage;
                currentStandardHourlySickPay = currentBaseSalaryEquivalentRate * sickPayPercentage;
                currentStandardHourlyOverheads = currentBaseSalaryEquivalentRate * businessOverheadsPercentage;

                // F. Subtotal: Cost Base
                const subtotalCostBase = currentBaseSalaryEquivalentRate + currentStandardHourlyVacationPay + currentStandardHourlyPensionSavings + currentStandardHourlySickPay + currentStandardHourlyOverheads;

                // G. Adjustment for Egenavgifter
                const adjustedForEgenavgifter = subtotalCostBase / (1 - egenavgifterRate);
                currentStandardHourlyEgenavgifter = adjustedForEgenavgifter - subtotalCostBase;

                // H. Profit Margin
                currentStandardHourlyProfitMargin = adjustedForEgenavgifter * profitMarginPercentage;

                // I. Calculated Hourly Rate (Excl. VAT)
                currentStandardTotalHourlyRate = adjustedForEgenavgifter + currentStandardHourlyProfitMargin;

                rateDisplayInfo.currentValues = [ 
                    currentBaseSalaryEquivalentRate, currentStandardHourlyVacationPay, currentStandardHourlyPensionSavings,
                    currentStandardHourlySickPay, currentStandardHourlyOverheads, currentStandardHourlyEgenavgifter,
                    currentStandardHourlyProfitMargin
                ];
                breakdownChart.data.datasets[0].data = rateDisplayInfo.currentValues;
                totalHourlyRateDisplayEl.textContent = currentStandardTotalHourlyRate.toFixed(0);
                breakdownChart.update(); 
                updateLegend();      
            }

            function getScaledComponentsForPremiumHour(overallRateMultiplier) {
                 return {
                    invoicedRate: currentStandardTotalHourlyRate * overallRateMultiplier,
                    grossSalary: currentBaseSalaryEquivalentRate * overallRateMultiplier,
                    vacationPay: currentStandardHourlyVacationPay * overallRateMultiplier,
                    pensionSavings: currentStandardHourlyPensionSavings * overallRateMultiplier,
                    sickPay: currentStandardHourlySickPay * overallRateMultiplier,
                    overheads: currentStandardHourlyOverheads * overallRateMultiplier,
                    egenavgifter: currentStandardHourlyEgenavgifter * overallRateMultiplier,
                    profitMargin: currentStandardHourlyProfitMargin * overallRateMultiplier
                };
            }
            
            function handleOBHoursChange() {
                let currentStandardHoursVal = parseFloat(hoursSliderEl.value);
                let newOB50 = parseFloat(ob50HoursInputEl.value) || 0;
                if (newOB50 < 0) { newOB50 = 0; ob50HoursInputEl.value = "0"; }
                let newOB70 = parseFloat(ob70HoursInputEl.value) || 0;
                if (newOB70 < 0) { newOB70 = 0; ob70HoursInputEl.value = "0"; }
                let newOB100 = parseFloat(ob100HoursInputEl.value) || 0;
                if (newOB100 < 0) { newOB100 = 0; ob100HoursInputEl.value = "0"; }

                const newTotalOB = newOB50 + newOB70 + newOB100;
                const deltaOBFromPreviousTotal = newTotalOB - previousTotalOBHoursGlobal;
                let newStandardHours = currentStandardHoursVal - deltaOBFromPreviousTotal;

                const minStdHours = parseFloat(hoursSliderEl.min);
                const maxStdHours = parseFloat(hoursSliderEl.max);
                if (newStandardHours < minStdHours) newStandardHours = minStdHours;
                if (newStandardHours > maxStdHours) newStandardHours = maxStdHours;

                hoursSliderEl.value = newStandardHours.toFixed(1);
                hoursNumberInputEl.value = newStandardHours.toFixed(1);
                hoursValueTextEl.textContent = newStandardHours.toFixed(1);
                previousTotalOBHoursGlobal = newTotalOB; 
                updateProjections();
            }

            function updateProjections() {
                const standardHours = parseFloat(hoursSliderEl.value); 
                const ob50Hours = parseFloat(ob50HoursInputEl.value) || 0;
                const ob70Hours = parseFloat(ob70HoursInputEl.value) || 0;
                const ob100Hours = parseFloat(ob100HoursInputEl.value) || 0;
                const shiftsWorked = parseInt(shiftsWorkedInputEl.value) || 0;

                const monthlyTransportationIncome = shiftsWorked * transportPerShift;
                transportationIncomeDisplayEl.textContent = formatCurrency(monthlyTransportationIncome);

                let totalMonthlyGrossSalary = 0, totalMonthlyVacationPay = 0, totalMonthlyPensionSavings = 0, totalMonthlySickPay = 0;
                let totalMonthlyOverheads = 0, totalMonthlyEgenavgifter = 0, totalMonthlyProfit = 0;

                totalMonthlyGrossSalary += standardHours * currentBaseSalaryEquivalentRate;
                totalMonthlyVacationPay += standardHours * currentStandardHourlyVacationPay;
                totalMonthlyPensionSavings += standardHours * currentStandardHourlyPensionSavings;
                totalMonthlySickPay += standardHours * currentStandardHourlySickPay;
                totalMonthlyOverheads += standardHours * currentStandardHourlyOverheads;
                totalMonthlyEgenavgifter += standardHours * currentStandardHourlyEgenavgifter;
                totalMonthlyProfit += standardHours * currentStandardHourlyProfitMargin;
                
                if (ob50Hours > 0) {
                    const premComps = getScaledComponentsForPremiumHour(1.5);
                    totalMonthlyGrossSalary += ob50Hours * premComps.grossSalary; totalMonthlyVacationPay += ob50Hours * premComps.vacationPay;
                    totalMonthlyPensionSavings += ob50Hours * premComps.pensionSavings; totalMonthlySickPay += ob50Hours * premComps.sickPay;
                    totalMonthlyOverheads += ob50Hours * premComps.overheads; totalMonthlyEgenavgifter += ob50Hours * premComps.egenavgifter;
                    totalMonthlyProfit += ob50Hours * premComps.profitMargin;
                }
                if (ob70Hours > 0) {
                     const premComps = getScaledComponentsForPremiumHour(1.7);
                    totalMonthlyGrossSalary += ob70Hours * premComps.grossSalary; totalMonthlyVacationPay += ob70Hours * premComps.vacationPay;
                    totalMonthlyPensionSavings += ob70Hours * premComps.pensionSavings; totalMonthlySickPay += ob70Hours * premComps.sickPay;
                    totalMonthlyOverheads += ob70Hours * premComps.overheads; totalMonthlyEgenavgifter += ob70Hours * premComps.egenavgifter;
                    totalMonthlyProfit += ob70Hours * premComps.profitMargin;
                }
                if (ob100Hours > 0) {
                    const premComps = getScaledComponentsForPremiumHour(2.0);
                    totalMonthlyGrossSalary += ob100Hours * premComps.grossSalary; totalMonthlyVacationPay += ob100Hours * premComps.vacationPay;
                    totalMonthlyPensionSavings += ob100Hours * premComps.pensionSavings; totalMonthlySickPay += ob100Hours * premComps.sickPay;
                    totalMonthlyOverheads += ob100Hours * premComps.overheads; totalMonthlyEgenavgifter += ob100Hours * premComps.egenavgifter;
                    totalMonthlyProfit += ob100Hours * premComps.profitMargin;
                }
                
                const totalMonthlyInvoicedExclMoms = totalMonthlyGrossSalary + totalMonthlyVacationPay + totalMonthlyPensionSavings + totalMonthlySickPay + totalMonthlyOverheads + totalMonthlyEgenavgifter + totalMonthlyProfit + monthlyTransportationIncome;

                monthlyInvoicedEl.textContent = formatCurrency(totalMonthlyInvoicedExclMoms);
                yearlyInvoicedEl.textContent = formatCurrency(totalMonthlyInvoicedExclMoms * 12);
                monthlySalaryEl.textContent = formatCurrency(totalMonthlyGrossSalary);
                yearlySalaryEl.textContent = formatCurrency(totalMonthlyGrossSalary * 12);
                monthlyVacationPayEl.textContent = formatCurrency(totalMonthlyVacationPay);
                yearlyVacationPayEl.textContent = formatCurrency(totalMonthlyVacationPay * 12);
                monthlyPensionSavingsEl.textContent = formatCurrency(totalMonthlyPensionSavings);
                yearlyPensionSavingsEl.textContent = formatCurrency(totalMonthlyPensionSavings * 12);
                monthlySickPayEl.textContent = formatCurrency(totalMonthlySickPay);
                yearlySickPayEl.textContent = formatCurrency(totalMonthlySickPay * 12);
                monthlyOverheadsEl.textContent = formatCurrency(totalMonthlyOverheads);
                yearlyOverheadsEl.textContent = formatCurrency(totalMonthlyOverheads * 12);
                monthlyProfitMarginEl.textContent = formatCurrency(totalMonthlyProfit);
                yearlyProfitMarginEl.textContent = formatCurrency(totalMonthlyProfit * 12);
                monthlySocialContributionsEl.textContent = formatCurrency(totalMonthlyEgenavgifter);
                yearlySocialContributionsEl.textContent = formatCurrency(totalMonthlyEgenavgifter * 12);

                const monthlyMomsVal = totalMonthlyInvoicedExclMoms * momsRate;
                monthlyMomsEl.textContent = formatCurrency(monthlyMomsVal);
                yearlyMomsEl.textContent = formatCurrency(monthlyMomsVal * 12);
                monthlyInvoicedWithMomsEl.textContent = formatCurrency(totalMonthlyInvoicedExclMoms + monthlyMomsVal);
                yearlyInvoicedWithMomsEl.textContent = formatCurrency((totalMonthlyInvoicedExclMoms + monthlyMomsVal) * 12);

                comparisonChart.data.datasets[0].data[0] = totalMonthlyGrossSalary;
                comparisonChart.data.datasets[1].data[0] = totalMonthlyVacationPay;
                comparisonChart.data.datasets[2].data[0] = totalMonthlyPensionSavings;
                comparisonChart.data.datasets[3].data[0] = totalMonthlySickPay;
                comparisonChart.data.datasets[4].data[0] = totalMonthlyOverheads;
                comparisonChart.data.datasets[5].data[0] = totalMonthlyEgenavgifter;
                comparisonChart.data.datasets[6].data[0] = totalMonthlyProfit;
                comparisonChart.update();
            }
            
            function updateLegend() {
                legendContainerEl.innerHTML = ''; 
                const totalForPercentage = rateDisplayInfo.currentValues.reduce((a, b) => a + b, 0); 
                rateDisplayInfo.labels.forEach((label, index) => {
                    const li = document.createElement('li'); li.className = 'flex items-center';
                    const value = rateDisplayInfo.currentValues[index] || 0; 
                    const percentage = currentStandardTotalHourlyRate > 0 ? ((value / currentStandardTotalHourlyRate) * 100).toFixed(1) : 0;
                    li.innerHTML = `<span class="w-3 h-3 rounded-full mr-2" style="background-color: ${donutBackgroundColors[index]}"></span>
                                    <span class="flex-grow">${label}</span>
                                    <span class="ml-auto font-medium text-right">${value.toFixed(2)} SEK (${percentage}%)</span>`;
                    legendContainerEl.appendChild(li);
                });
            }
            const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'SEK', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
            
            function addEventListenersAndRun() {
                const allInputs = [grossSalaryInputEl, hoursSliderEl, hoursNumberInputEl, ob50HoursInputEl, ob70HoursInputEl, ob100HoursInputEl, shiftsWorkedInputEl];
                allInputs.forEach(input => {
                    input.addEventListener('input', () => {
                        saveInputs();
                         if (input.id === 'grossSalaryInput') {
                            calculateStandardHourlyRateComponents(grossSalaryInputEl.value);
                            updateProjections();
                        } else if (['ob50HoursInput', 'ob70HoursInput', 'ob100HoursInput'].includes(input.id)) {
                             handleOBHoursChange();
                        } else if (input.id === 'hoursSlider') {
                            const val = parseFloat(input.value).toFixed(1);
                            hoursValueTextEl.textContent = val;
                            hoursNumberInputEl.value = val;
                            updateProjections();
                        } else {
                            updateProjections();
                        }
                    });

                    if(input.type === 'number') {
                        input.addEventListener('change', (e) => {
                             let val = parseFloat(e.target.value);
                             const min = parseFloat(e.target.min);
                             const max = parseFloat(e.target.max);
                             if (isNaN(val) || val < min) val = min;
                             if (!isNaN(max) && val > max) val = max;
                             
                             e.target.value = e.target.id.includes('Hours') ? val.toFixed(1) : val;

                             if (e.target.id === 'hoursNumberInput') {
                                 hoursSliderEl.value = val.toFixed(1);
                                 hoursValueTextEl.textContent = val.toFixed(1);
                                 updateProjections();
                             } else if (['ob50HoursInput', 'ob70HoursInput', 'ob100HoursInput'].includes(e.target.id)) {
                                 handleOBHoursChange();
                             } else {
                                 updateProjections();
                             }
                             saveInputs();
                        });
                    }
                });
            }
            
            // Initial Setup
            loadInputs();
            previousTotalOBHoursGlobal = (parseFloat(ob50HoursInputEl.value) || 0) +
                                         (parseFloat(ob70HoursInputEl.value) || 0) +
                                         (parseFloat(ob100HoursInputEl.value) || 0);
            calculateStandardHourlyRateComponents(grossSalaryInputEl.value); 
            addEventListenersAndRun();
            updateProjections();
        });
    </script>
</body>
</html>
